<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Fantasy Football Weekly Rankings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background: #f8f9fa; }
    .card { border: 0; }
    .player-row:hover { background: rgba(13,110,253,0.03); }
    .trash-btn { width: 36px; }
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h4 mb-0">Fantasy Football Weekly Rankings</h1>
        <small class="text-muted">Aggregated NFL • RotoPat • FantasyPros</small>
      </div>
      <div class="text-end">
        <label class="small text-muted">Week</label>
        <div class="input-group">
          <input id="week-input" type="number" min="1" max="17" class="form-control form-control-sm" style="width:110px" value="{{ week }}">
          <button id="refresh-rankings" class="btn btn-sm btn-primary">Update</button>
        </div>
      </div>
    </header>

    <div class="row g-3">
      <!-- Current Roster -->
      <div class="col-lg-5">
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h5 class="card-title mb-3">Current Roster</h5>
            <div id="roster-groups"></div>
          </div>
        </div>

        <!-- Add Player -->
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Add Player</h5>
            <form id="add-player-form" class="row g-2">
              <div class="col-12">
                <label class="form-label small">Player Name</label>
                <input id="player-name" class="form-control form-control-sm" placeholder="Input Player Name" required>
              </div>
              <div class="col-12">
                <label class="form-label small">Position</label>
                <select id="player-position" class="form-select form-select-sm" required>
                  <option value="QB">QB</option>
                  <option value="RB">RB</option>
                  <option value="WR">WR</option>
                  <option value="TE">TE</option>
                  <option value="K">K</option>
                  <option value="DEF">DEF</option>
                </select>
              </div>
              <div class="col-12 d-grid">
                <button class="btn btn-success btn-sm" type="submit">
                  <i class="bi bi-plus-lg"></i> Add Player
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Rankings -->
      <div class="col-lg-7">
        <div id="rankings-area"></div>
      </div>
    </div>

    <footer class="mt-4 text-center text-muted small">
      Built by <a href="https://github.com/JTH10" target="_blank">Justin Henrie</a>
    </footer>
  </div>

  <script>
    const POSITION_ORDER = {{ position_order|tojson }};
    const playerListContainer = document.getElementById('roster-groups');
    const addForm = document.getElementById('add-player-form');
    const weekInput = document.getElementById('week-input');
    const refreshBtn = document.getElementById('refresh-rankings');
    const rankingsArea = document.getElementById('rankings-area');

    // ---------- Load Players ----------
    async function loadPlayersGrouped() {
      const res = await fetch('/players');
      const grouped = await res.json();
      renderRosterGroups(grouped);
    }

    function createPlayerRow(p) {
      const row = document.createElement('div');
      row.className = 'd-flex align-items-center justify-content-between py-2 player-row';
      row.innerHTML = `
        <div>
          <div class="fw-medium">${p.name}</div>
          <div class="text-muted small">${p.position}</div>
        </div>
      `;
      const btn = document.createElement('button');
      btn.className = 'btn btn-outline-danger btn-sm trash-btn';
      btn.title = 'Remove player';
      btn.innerHTML = '<i class="bi bi-trash"></i>';
      btn.onclick = async (e) => {
        e.stopPropagation();
        if (!confirm('Remove ' + p.name + ' from roster?')) return;
        const resp = await fetch('/players/' + encodeURIComponent(p.name), { method: 'DELETE' });
        if (resp.ok) {
          await loadPlayersGrouped();
          await loadRankings();
        } else {
          const err = await resp.json();
          alert('Error: ' + (err.error || 'Could not delete'));
        }
      };
      row.appendChild(btn);
      return row;
    }

    function renderRosterGroups(grouped) {
      playerListContainer.innerHTML = '';
      POSITION_ORDER.forEach(pos => {
        const list = grouped[pos] || [];
        if (!list.length) return;
        const container = document.createElement('div');
        container.className = 'mb-3';
        container.innerHTML = `<h6 class="mb-2">${pos}</h6>`;
        const box = document.createElement('div');
        box.className = 'bg-white border rounded p-2';
        list.forEach(p => box.appendChild(createPlayerRow(p)));
        container.appendChild(box);
        playerListContainer.appendChild(container);
      });
      Object.keys(grouped).forEach(pos => {
        if (POSITION_ORDER.includes(pos)) return;
        const list = grouped[pos] || [];
        if (!list.length) return;
        const container = document.createElement('div');
        container.className = 'mb-3';
        container.innerHTML = `<h6 class="mb-2">${pos}</h6>`;
        const box = document.createElement('div');
        box.className = 'bg-white border rounded p-2';
        list.forEach(p => box.appendChild(createPlayerRow(p)));
        container.appendChild(box);
        playerListContainer.appendChild(container);
      });
    }

    // ---------- Add Player ----------
    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('player-name').value.trim();
      const position = document.getElementById('player-position').value;
      if (!name) return;
      const resp = await fetch('/players', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name, position })
      });
      if (resp.status === 201) {
        document.getElementById('player-name').value = '';
        await loadPlayersGrouped();
        await loadRankings();
      } else {
        const err = await resp.json();
        alert('Error: ' + (err.error || 'Unable to add player'));
      }
    });

    // ---------- Load Rankings ----------
    async function loadRankings() {
      let week = parseInt(weekInput.value) || {{ week }};
      rankingsArea.innerHTML = '';
      const spinner = document.createElement('div');
      spinner.className = 'text-center py-5';
      spinner.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';
      rankingsArea.appendChild(spinner);

      try {
        const res = await fetch('/rankings?week=' + encodeURIComponent(week));
        if (!res.ok) {
          const err = await res.json();
          rankingsArea.innerHTML = `<div class="alert alert-danger">Error: ${err.error || 'Could not fetch rankings'}</div>`;
          return;
        }
        const data = await res.json();
        renderRankings(data, week);
      } catch {
        rankingsArea.innerHTML = `<div class="alert alert-danger">Network error fetching rankings.</div>`;
      }
    }

    function renderRankings(data, week) {
      rankingsArea.innerHTML = '';
      POSITION_ORDER.forEach(pos => {
        const players = data[pos] || [];
        if (!players.length) return;
        const card = document.createElement('div');
        card.className = 'card mb-3 shadow-sm';
        const body = document.createElement('div');
        body.className = 'card-body';
        body.innerHTML = `<h5 class="card-title mb-3">${pos} — Week ${week}</h5>`;
        const table = document.createElement('table');
        table.className = 'table table-sm table-hover mb-0';
        table.innerHTML = `
          <thead class="table-light"><tr>
            <th>Name</th><th>NFL</th><th>RotoPat</th><th>FantasyPros</th><th>Avg</th>
          </tr></thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        players.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.name}</td>
            <td>${p.nfl_rank ?? '<span class="text-muted small">NR</span>'}</td>
            <td>${p.rotopat_rank ?? '<span class="text-muted small">NR</span>'}</td>
            <td>${p.fantasypros_rank ?? '<span class="text-muted small">NR</span>'}</td>
            <td>${p.average_rank ?? '<span class="text-muted small">N/A</span>'}</td>
          `;
          tbody.appendChild(tr);
        });
        body.appendChild(table);
        card.appendChild(body);
        rankingsArea.appendChild(card);
      });
    }

    // ---------- Events ----------
    refreshBtn.addEventListener('click', loadRankings);

    // ---------- Initial Load ----------
    (async () => {
      await loadPlayersGrouped();
      await loadRankings();
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
